<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Provider CPT Claims Report</title>
  <style>
    :root { --blue:#2563eb; --slate:#1e3a8a; --bg:#f9fafb; --line:#e5e7eb; --text:#111827; --green:#059669; --green-bg:#d1fae5; --red:#b91c1c; --red-bg:#fee2e2; }
    body { font-family: Arial, sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
    h1, h2, h3 { color: var(--slate); }
    textarea, input, button, select { font-family: inherit; }
    textarea { width: 100%; height: 150px; border: 1px solid #ccc; border-radius: 8px; padding: 10px; margin-bottom: 12px; background:white; }
    input, select { padding: 8px 10px; border-radius: 8px; border: 1px solid #ccc; background:white; }
    button { background: var(--blue); color: white; border: none; padding: 9px 14px; border-radius: 8px; cursor: pointer; margin-right: 6px; }
    button.secondary { background: white; color: var(--blue); border: 1px solid var(--blue); }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .card { background: white; border-radius: 12px; padding: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 16px; border:1px solid #eef2f7; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border: 1px solid var(--line); padding: 8px 10px; text-align: left; font-size: 13px; background:white; }
    th { background-color: #f3f4f6; font-weight: 600; }
    tr:nth-child(even) td { background-color: #fbfdff; }
    .note { color:#374151; font-size:13px; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; letter-spacing: .2px; }
    .pill-paid { background: var(--green-bg); color: var(--green); border: 1px solid #a7f3d0; }
    .pill-unpaid { background: var(--red-bg); color: var(--red); border: 1px solid #fecaca; }
    .section-title { display:flex; align-items:center; justify-content:space-between; }
    .muted { color:#6b7280; font-size:12px; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center; }
    .provider-list { display:flex; flex-wrap:wrap; gap:8px; max-height:120px; overflow:auto; padding:6px; border:1px dashed var(--line); border-radius:8px; background:#fff; }
    .provider-list label { display:flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; background:#f8fafc; font-size:12px; }
    .kpis { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px; margin-top:8px; }
    .kpi { background: white; border:1px solid var(--line); border-radius:12px; padding:14px; }
    .kpi h4 { margin:0; font-size:13px; color:#6b7280; font-weight:600; }
    .kpi .val { font-size:28px; font-weight:800; margin-top:6px; color:#111827; }
    .pill-legend { display:flex; gap:10px; align-items:center; }
    @media print { button, textarea, input, select, .note { display:none; } .card { box-shadow:none; border:1px solid var(--line); break-inside: avoid; } }
  </style>
</head>
<body>
  <h1>Provider CPT Claims Report</h1>
  <p class="note">Upload or paste CSV/TSV. The report auto-extracts the provider (if present) and shows summaries with claim-level detail. Supports comparing up to 5 providers and multi-file upload.</p>
  <div class="row" style="margin-bottom:8px;">
    <label>Provider Name: <input type="text" id="providerName" placeholder="Used if Provider column missing" /></label>
    <input type="file" accept=".csv,.tsv" multiple onchange="readFiles(this)">
  </div>
  <textarea id="data" placeholder="Paste data here..."></textarea>
  <div>
    <button onclick="analyze()">Generate Report</button>
    <button class="secondary" onclick="document.getElementById('data').value='';document.getElementById('output').innerHTML='';document.getElementById('providerName').value='';">Clear</button>
  </div>

  <div id="output"></div>

  <script>
    // ---------------- File load ----------------
    async function readFiles(input){
      const files = Array.from(input.files || []);
      if (!files.length) return;
      if (files.length > 5){ alert('Please select at most 5 files. Using the first 5.'); files.length = 5; }
      const texts = await Promise.all(files.map(f=>f.text()));
      // Merge with single header
      let header = '';
      const bodyLines = [];
      for (let t of texts){
        const norm = t.replace(/\r\n?|\n/g, '\n');
        const lines = norm.split('\n').filter(l=>l.trim().length>0);
        if (!lines.length) continue;
        if (!header){ header = lines[0]; bodyLines.push(...lines.slice(1)); }
        else {
          const maybeHeader = lines[0].trim();
          const startIdx = (maybeHeader.toLowerCase() === header.trim().toLowerCase()) ? 1 : 0;
          bodyLines.push(...lines.slice(startIdx));
        }
      }
      if (!header){ alert('No readable rows found in the selected files.'); return; }
      document.getElementById('data').value = [header, ...bodyLines].join('\n');
    }

    // ---------------- Parsing ----------------
    function detectDelimiter(text){
      const first = (text.split(/\r?\n/).find(l => l.trim().length) || '');
      return first.includes('\t') ? '\t' : ',';
    }

    function parseDelimited(text, delim){
      const rows = [];
      let field = '', row = [], inQuotes = false;
      for (let i = 0; i < text.length; i++){
        const c = text[i];
        if (inQuotes){
          if (c === '"'){
            const next = text[i+1];
            if (next === '"'){ field += '"'; i++; }
            else { inQuotes = false; }
          } else { field += c; }
        } else {
          if (c === '"') inQuotes = true;
          else if (c === delim) { row.push(field); field = ''; }
          else if (c === '\n') { row.push(field); rows.push(row); row = []; field = ''; }
          else if (c !== '\r') { field += c; }
        }
      }
      if (field.length || row.length){ row.push(field); rows.push(row); }
      return rows.map(r => r.map(x => (x ?? '').trim())).filter(r => r.some(x => x !== ''));
    }

    // ---------------- Helpers ----------------
    function normalizeMoney(str){
      if (!str) return 0;
      let s = String(str).replace(/[$,\s]/g, '').trim();
      if (s.startsWith('(') && s.endsWith(')')) s = '-' + s.slice(1, -1);
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    function idxOf(header, candidates){
      const lower = header.map(h => (h||'').toLowerCase());
      for (const cand of candidates){
        const i = lower.indexOf(cand.toLowerCase());
        if (i !== -1) return i;
      }
      return -1;
    }

    function parseDOS(str){
      if(!str) return null;
      const s = String(str).trim();
      const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(iso) return new Date(+iso[1], +iso[2]-1, +iso[3]);
      const mdy = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if(mdy){ let y = +mdy[3]; if(y<100) y+=2000; return new Date(y, +mdy[1]-1, +mdy[2]); }
      const t = Date.parse(s);
      return isNaN(t)? null : new Date(t);
    }

    function encBreakdown(rows){
      const encSet = new Set(rows.map(x=> x.patient_id || x.patient))
      const paidSet = new Set();
      encSet.forEach(k=>{ const any = rows.some(v=> (v.patient_id||v.patient)===k && v.isPaid); if(any) paidSet.add(k); });
      const enc = encSet.size, paid = paidSet.size, unpaid = enc - paid;
      return { enc, paid, unpaid, pct: enc? Math.round(paid/enc*100) : 0 };
    }

    function fmtMoney(n){ return '$' + n.toFixed(2); }

    // ---------------- Main ----------------
    function analyze(){
      const text = document.getElementById('data').value.trim();
      const output = document.getElementById('output');
      output.innerHTML = '';
      if (!text){ alert('Please paste data or upload a file.'); return; }

      const delim = detectDelimiter(text);
      const rows = parseDelimited(text, delim);
      if (rows.length < 2){ output.innerHTML = '<p>No rows detected.</p>'; return; }

      const header = rows[0];
      const dataRows = rows.slice(1);
      const iCPT = idxOf(header, ['cpt']);
      const iUnits = idxOf(header, ['days_or_units','units','days']);
      const iCharges = idxOf(header, ['charges','charge']);
      const iPaid = idxOf(header, ['insurance_payment','paid','payment']);
      const iPatient = idxOf(header, ['patient_name','patient']);
      const iPatientID = idxOf(header, ['patient_id','id']);
      const iDOS = idxOf(header, ['date_of_service','dos','date']);
      const iPayer = idxOf(header, ['insurance provider','payer','insurance','plan','insurance_name','insurance provider name']);
      const iProvider = idxOf(header, [
        'provider','rendering provider','rendering_provider','attending','attending_provider',
        'billing provider','billing_provider','ordering provider','ordering_provider','physician','provider_name','office provider'
      ]);

      if (iCPT === -1){ output.innerHTML = '<p>Could not find a CPT column.</p>'; return; }

      // Extract claims into A/Q/L and Numeric (0â€“9)
      const claimsAQL = [];
      const claimsNUM = [];
      let claimCounter = 0;
      for (const r of dataRows){
        const cpt = String(r[iCPT] || '').trim();
        if (!cpt) continue;
        const units = parseFloat(r[iUnits]) || 0;
        const charge = normalizeMoney(r[iCharges]);
        const paid = Math.abs(normalizeMoney(r[iPaid]));
        const patient = r[iPatient] || '';
        const patient_id = r[iPatientID] || '';
        const payer = iPayer !== -1 ? (r[iPayer] || '') : '';
        const providerCellRaw = (iProvider!==-1 ? (r[iProvider]||'') : '').trim();
        const provider = providerCellRaw || (document.getElementById('providerName').value.trim() || 'Unknown Provider');
        const isPaid = paid > 0;
        const dos = iDOS!==-1 ? (r[iDOS]||'') : '';
        const d = parseDOS(dos);
        const dateSort = d? d.getTime() : Infinity;
        const leading = cpt[0] || '';
        const codeType = /^[AQL]/i.test(cpt) ? leading.toUpperCase() : (/^[0-9]/.test(cpt) ? 'NUM' : leading.toUpperCase());
        const obj = { claimNo: (++claimCounter), provider, cpt, codeType, units, charge, paid, patient, patient_id, payer, isPaid, dos, dateSort };
        if (/^[AQL]/i.test(cpt)) claimsAQL.push(obj);
        else if (/^[0-9]/.test(cpt)) claimsNUM.push(obj);
        else { claimsNUM.push(obj); }
      }

      if (!claimsAQL.length && !claimsNUM.length){ output.innerHTML = '<p>No claims detected.</p>'; return; }

      const allClaims = claimsAQL.concat(claimsNUM);
      const providers = Array.from(new Set(allClaims.map(c=>c.provider))).sort((a,b)=>a.localeCompare(b));
      const byProvUnits = new Map();
      allClaims.forEach(c=> byProvUnits.set(c.provider, (byProvUnits.get(c.provider)||0)+c.units));
      const top5 = providers.slice().sort((a,b)=> (byProvUnits.get(b)||0) - (byProvUnits.get(a)||0)).slice(0,5);
      const selectedProviders = new Set(top5);

      // ===== Report header =====
      const reportHeader = document.createElement('div');
      reportHeader.className = 'card';
      const pLabel = providers.length>1 ? `${providers.length} providers` : providers[0] || (document.getElementById('providerName').value.trim()||'Unknown Provider');
      reportHeader.innerHTML = `<div class="section-title"><h2>Report for ${pLabel}</h2><span class="muted">Generated: ${new Date().toLocaleString()}</span></div>
      <div class="muted">Includes A/Q/L and Numeric (0â€“9) CPT codes</div>`;
      const kpiWrap = document.createElement('div'); kpiWrap.className='kpis';
      const kpi1 = document.createElement('div'); kpi1.className='kpi';
      const kpi2 = document.createElement('div'); kpi2.className='kpi';
      kpi1.innerHTML = `<h4>Total Collected</h4><div class="val" id="kpiCollected">$0.00</div>`;
      kpi2.innerHTML = `<h4>Total Encounters</h4><div class="val" id="kpiEnc">0</div>`;
      kpiWrap.appendChild(kpi1); kpiWrap.appendChild(kpi2); reportHeader.appendChild(kpiWrap);
      output.appendChild(reportHeader);

      function renderKPI(){
        const considered = allClaims.filter(c=> selectedProviders.size? selectedProviders.has(c.provider): true);
        const totalCollected = considered.reduce((s,x)=> s + x.paid, 0);
        const eb = encBreakdown(considered);
        document.getElementById('kpiCollected').textContent = fmtMoney(totalCollected);
        document.getElementById('kpiEnc').textContent = eb.enc;
      }

      // ===== Provider Comparison (A/Q/L) =====
      const aqlCard = document.createElement('div'); aqlCard.className='card';
      aqlCard.innerHTML = `<div class="section-title"><h3>Provider Comparison (A/Q/L)</h3><span class="muted">Select up to 5 providers</span></div>`;
      const provControls = document.createElement('div'); provControls.className='provider-list';
      providers.forEach(p=>{
        const lbl = document.createElement('label');
        const cb = document.createElement('input'); cb.type='checkbox'; cb.value=p; cb.checked = selectedProviders.has(p);
        cb.addEventListener('change', ()=>{
          const checked = Array.from(provControls.querySelectorAll('input[type=checkbox]:checked'));
          if (checked.length>5){ cb.checked=false; alert('Please select at most 5 providers.'); return; }
          selectedProviders.clear(); checked.forEach(x=> selectedProviders.add(x.value));
          renderKPI();
          renderProviderComparisonAQL();
          rebuildAndRenderSummaryAQL();
          rebuildAndRenderSummaryNUM();
          renderProviderBreakdownsNUM();
          renderClaimsNUMPaid();
          renderClaimsNUMUnpaid();
          renderClaimsAQLPaid();
          renderClaimsAQLUnpaid();
        });
        lbl.appendChild(cb); lbl.appendChild(document.createTextNode(p)); provControls.appendChild(lbl);
      });
      aqlCard.appendChild(provControls);

      const provTable = document.createElement('table');
      provTable.innerHTML = `<thead><tr>
        <th>Provider</th>
        <th>Total Units</th>
        <th>Units Paid</th>
        <th>Units Unpaid</th>
        <th>Paid %</th>
        <th>Total Paid ($)</th>
        <th>Encounters</th>
        <th>Paid Enc</th>
        <th>Unpaid Enc</th>
        <th>Paid Enc %</th>
        <th>L Units</th>
        <th>Q Units</th>
        <th>A Units</th>
      </tr></thead>`;
      const provBody = document.createElement('tbody');
      provTable.appendChild(provBody); aqlCard.appendChild(provTable); output.appendChild(aqlCard);

      function renderProviderComparisonAQL(){
        provBody.innerHTML='';
        const provs = selectedProviders.size? Array.from(selectedProviders) : providers;
        provs.sort((a,b)=> (byProvUnits.get(b)||0) - (byProvUnits.get(a)||0));
        provs.forEach(p=>{
          const rows = claimsAQL.filter(c=>c.provider===p);
          const totalUnits = rows.reduce((s,x)=>s+x.units,0);
          const unitsPaid = rows.filter(x=>x.isPaid).reduce((s,x)=>s+x.units,0);
          const unitsUnpaid = totalUnits - unitsPaid;
          const paidPct = totalUnits? Math.round((unitsPaid/totalUnits)*100) : 0;
          const totalPaidAmt = rows.reduce((s,x)=>s+x.paid,0);
          const eb = encBreakdown(rows);
          const L = rows.filter(r=>r.codeType==='L').reduce((s,x)=>s+x.units,0);
          const Q = rows.filter(r=>r.codeType==='Q').reduce((s,x)=>s+x.units,0);
          const A = rows.filter(r=>r.codeType==='A').reduce((s,x)=>s+x.units,0);
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${p}</td><td>${Math.round(totalUnits)}</td><td>${Math.round(unitsPaid)}</td><td>${Math.round(unitsUnpaid)}</td><td>${paidPct}%</td><td>${fmtMoney(totalPaidAmt)}</td><td>${eb.enc}</td><td>${eb.paid}</td><td>${eb.unpaid}</td><td>${eb.pct}%</td><td>${Math.round(L)}</td><td>${Math.round(Q)}</td><td>${Math.round(A)}</td>`;
          provBody.appendChild(tr);
        });
      }

      // Kick initial renders
      renderKPI();
      renderProviderComparisonAQL();

      // ===== Highâ€‘Level Summary by CPT Code (A/Q/L) =====
      const summaryCard = document.createElement('div'); summaryCard.className='card'; summaryCard.innerHTML = `<h3>Highâ€‘Level Summary by CPT Code (A/Q/L)</h3>`;
      const controls = document.createElement('div'); controls.className='controls';
      const codeSelect = document.createElement('select'); codeSelect.id='codeFilterAQL';
      const paidSelect = document.createElement('select'); paidSelect.id='paidFilterAQL';
      paidSelect.innerHTML = `<option value="">All payment states</option><option value="paid">Paid only</option><option value="unpaid">Unpaid only</option>`;
      controls.appendChild(document.createTextNode('Filter:')); controls.appendChild(codeSelect); controls.appendChild(paidSelect); summaryCard.appendChild(controls);
      const summaryTable = document.createElement('table');
      summaryTable.innerHTML = '<thead><tr>'+
        '<th style="width:12%">CPT Code</th>'+
        '<th style="width:10%">Total Units</th>'+
        '<th style="width:10%">Units Paid</th>'+
        '<th style="width:10%">Units Unpaid</th>'+
        '<th style="width:8%">Paid %</th>'+
        '<th style="width:10%">Encounters</th>'+
        '<th style="width:10%">Paid Enc</th>'+
        '<th style="width:10%">Unpaid Enc</th>'+
        '<th style="width:10%">Paid Enc %</th>'+
        '<th style="width:10%">Total Paid ($)</th>'+
      '</tr></thead>';
      const sbody = document.createElement('tbody');
      const sfoot = document.createElement('tfoot');

      function rebuildAndRenderSummaryAQL(){
        const filteredClaims = claimsAQL.filter(c=> selectedProviders.size? selectedProviders.has(c.provider) : true);
        const byCode = new Map(); filteredClaims.forEach(r=>{ if(!byCode.has(r.cpt)) byCode.set(r.cpt, []); byCode.get(r.cpt).push(r); });
        const codes = Array.from(byCode.keys()).sort((a,b)=>a.localeCompare(b));
        codeSelect.innerHTML = `<option value="">All CPT codes (${codes.length})</option>` + codes.map(c=>`<option value="${c}">${c}</option>`).join('');
        const codeRows = codes.map(code=>{
          const vals = byCode.get(code);
          const totalUnits = vals.reduce((s,x)=>s+x.units,0);
          const unitsPaid = vals.filter(x=>x.isPaid).reduce((s,x)=>s+x.units,0);
          const unitsUnpaid = totalUnits - unitsPaid;
          const eb = encBreakdown(vals);
          const totalPaid = vals.reduce((s,x)=>s+x.paid,0);
          return { code, totalUnits, unitsPaid, unitsUnpaid, encounters: eb.enc, paidEnc: eb.paid, unpaidEnc: eb.unpaid, paidEncPct: eb.pct, totalPaid };
        });
        sbody.innerHTML='';
        const selCode = codeSelect.value; const selPaid = paidSelect.value;
        let T_total=0, T_paid=0, T_amt=0;
        codeRows.forEach(r=>{
          if (selCode && r.code !== selCode) return;
          if (selPaid==='paid' && r.unitsPaid===0) return;
          if (selPaid==='unpaid' && r.unitsUnpaid===0) return;
          const paidPct = r.totalUnits ? Math.round((r.unitsPaid/r.totalUnits)*100) : 0;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.code}</td>
            <td>${Math.round(r.totalUnits)}</td>
            <td>${Math.round(r.unitsPaid)}</td>
            <td>${Math.round(r.unitsUnpaid)}</td>
            <td>${paidPct}%</td>
            <td>${r.encounters}</td>
            <td>${r.paidEnc}</td>
            <td>${r.unpaidEnc}</td>
            <td>${r.paidEncPct}%</td>
            <td>${fmtMoney(r.totalPaid)}</td>`;
          sbody.appendChild(tr);
          T_total += r.totalUnits; T_paid += r.unitsPaid; T_amt += r.totalPaid;
        });
        const T_unpaid = T_total - T_paid; const T_pct = T_total ? Math.round((T_paid/T_total)*100) : 0;
        const ebAll = encBreakdown(filteredClaims);
        sfoot.innerHTML = `<tr>
          <td><strong>Total</strong></td>
          <td><strong>${Math.round(T_total)}</strong></td>
          <td><strong>${Math.round(T_paid)}</strong></td>
          <td><strong>${Math.round(T_unpaid)}</strong></td>
          <td><strong>${T_pct}%</strong></td>
          <td><strong>${ebAll.enc}</strong></td>
          <td><strong>${ebAll.paid}</strong></td>
          <td><strong>${ebAll.unpaid}</strong></td>
          <td><strong>${ebAll.pct}%</strong></td>
          <td><strong>${fmtMoney(T_amt)}</strong></td>
        </tr>`;
      }
      rebuildAndRenderSummaryAQL();
      codeSelect.addEventListener('change', rebuildAndRenderSummaryAQL);
      paidSelect.addEventListener('change', rebuildAndRenderSummaryAQL);
      summaryTable.appendChild(sbody); summaryTable.appendChild(sfoot); summaryCard.appendChild(summaryTable); output.appendChild(summaryCard);

      // ===== Per-Provider CPT Breakdown (A/Q/L) =====
      if (claimsAQL.length){
        const selectedProvsA = Array.from(selectedProviders.size? selectedProviders : providers);
        selectedProvsA.forEach(p => {
          const pCard = document.createElement('div'); pCard.className = 'card'; pCard.innerHTML = `<h3>Provider Breakdown â€” ${p} (A/Q/L)</h3>`;
          const rowsP = claimsAQL.filter(c=>c.provider===p);
          const byCodeP = new Map(); rowsP.forEach(r=>{ if(!byCodeP.has(r.cpt)) byCodeP.set(r.cpt, []); byCodeP.get(r.cpt).push(r); });
          const codesP = Array.from(byCodeP.keys()).sort((a,b)=>a.localeCompare(b));
          const tblP = document.createElement('table');
          tblP.innerHTML = `<thead><tr>
            <th style='width:12%'>CPT Code</th>
            <th style='width:10%'>Total Units</th>
            <th style='width:10%'>Units Paid</th>
            <th style='width:10%'>Units Unpaid</th>
            <th style='width:8%'>Paid %</th>
            <th style='width:10%'>Encounters</th>
            <th style='width:10%'>Paid Enc</th>
            <th style='width:10%'>Unpaid Enc</th>
            <th style='width:10%'>Paid Enc %</th>
            <th style='width:10%'>Total Paid ($)</th>
          </tr></thead>`;
          const tbP = document.createElement('tbody');
          let TT=0, TP=0, TAmt=0; let TEnc=0, TEncPaid=0;
          codesP.forEach(code=>{
            const vals = byCodeP.get(code);
            const totalUnits = vals.reduce((s,x)=>s+x.units,0);
            const unitsPaid = vals.filter(x=>x.isPaid).reduce((s,x)=>s+x.units,0);
            const unitsUnpaid = totalUnits - unitsPaid;
            const paidPct = totalUnits? Math.round(unitsPaid/totalUnits*100) : 0;
            const eb = encBreakdown(vals);
            const totalPaid = vals.reduce((s,x)=>s+x.paid,0);
            const rowEl = document.createElement('tr'); rowEl.innerHTML = `<td>${code}</td><td>${Math.round(totalUnits)}</td><td>${Math.round(unitsPaid)}</td><td>${Math.round(unitsUnpaid)}</td><td>${paidPct}%</td><td>${eb.enc}</td><td>${eb.paid}</td><td>${eb.unpaid}</td><td>${eb.pct}%</td><td>${fmtMoney(totalPaid)}</td>`;
            tbP.appendChild(rowEl);
            TT+=totalUnits; TP+=unitsPaid; TAmt+=totalPaid; TEnc+=eb.enc; TEncPaid+=eb.paid;
          });
          const TUnpaid = TT-TP; const TPct = TT? Math.round(TP/TT*100):0; const TEncUnpaid = TEnc - TEncPaid; const TEncPct = TEnc? Math.round(TEncPaid/TEnc*100):0;
          const tfoot = document.createElement('tfoot'); tfoot.innerHTML = `<tr><td><strong>Total</strong></td><td><strong>${Math.round(TT)}</strong></td><td><strong>${Math.round(TP)}</strong></td><td><strong>${Math.round(TUnpaid)}</strong></td><td><strong>${TPct}%</strong></td><td><strong>${TEnc}</strong></td><td><strong>${TEncPaid}</strong></td><td><strong>${TEncUnpaid}</strong></td><td><strong>${TEncPct}%</strong></td><td><strong>${fmtMoney(TAmt)}</strong></td></tr>`;
          tblP.appendChild(tbP); tblP.appendChild(tfoot); pCard.appendChild(tblP); output.appendChild(pCard);
        });
      }

      // ===== Highâ€‘Level Summary by CPT Code (0â€“9) =====
      if (claimsNUM.length){
        const summaryNum = document.createElement('div'); summaryNum.className='card'; summaryNum.innerHTML = `<h3>Highâ€‘Level Summary by CPT Code (0â€“9)</h3>`;
        const controlsN = document.createElement('div'); controlsN.className='controls';
        const codeSelectN = document.createElement('select'); codeSelectN.id='codeFilterNUM';
        const paidSelectN = document.createElement('select'); paidSelectN.id='paidFilterNUM'; paidSelectN.innerHTML = `<option value="">All payment states</option><option value="paid">Paid only</option><option value="unpaid">Unpaid only</option>`;
        controlsN.appendChild(document.createTextNode('Filter:')); controlsN.appendChild(codeSelectN); controlsN.appendChild(paidSelectN); summaryNum.appendChild(controlsN);
        const tableN = document.createElement('table');
        tableN.innerHTML = `<thead><tr>
          <th style='width:12%'>CPT Code</th>
          <th style='width:10%'>Total Units</th>
          <th style='width:10%'>Units Paid</th>
          <th style='width:10%'>Units Unpaid</th>
          <th style='width:8%'>Paid %</th>
          <th style='width:10%'>Encounters</th>
          <th style='width:10%'>Paid Enc</th>
          <th style='width:10%'>Unpaid Enc</th>
          <th style='width:10%'>Paid Enc %</th>
          <th style='width:10%'>Total Paid ($)</th>
        </tr></thead>`;
        const tbodyN = document.createElement('tbody');
        const tfootN = document.createElement('tfoot');
        function rebuildAndRenderSummaryNUM(){
          const filtered = claimsNUM.filter(c=> selectedProviders.size? selectedProviders.has(c.provider) : true);
          const byCode = new Map(); filtered.forEach(r=>{ if(!byCode.has(r.cpt)) byCode.set(r.cpt, []); byCode.get(r.cpt).push(r); });
          const codes = Array.from(byCode.keys()).sort((a,b)=>a.localeCompare(b));
          codeSelectN.innerHTML = `<option value="">All CPT codes (${codes.length})</option>` + codes.map(c=>`<option value='${c}'>${c}</option>`).join('');
          const rowsN = codes.map(code=>{
            const vals = byCode.get(code);
            const totalUnits = vals.reduce((s,x)=>s+x.units,0);
            const unitsPaid = vals.filter(x=>x.isPaid).reduce((s,x)=>s+x.units,0);
            const unitsUnpaid = totalUnits - unitsPaid;
            const eb = encBreakdown(vals);
            const totalPaid = vals.reduce((s,x)=>s+x.paid,0);
            return { code, totalUnits, unitsPaid, unitsUnpaid, encounters: eb.enc, paidEnc: eb.paid, unpaidEnc: eb.unpaid, paidEncPct: eb.pct, totalPaid };
          });
          tbodyN.innerHTML='';
          const selCode = codeSelectN.value; const selPaid = paidSelectN.value;
          let T_total=0, T_paid=0, T_amt=0;
          rowsN.forEach(r=>{
            if (selCode && r.code !== selCode) return;
            if (selPaid==='paid' && r.unitsPaid===0) return;
            if (selPaid==='unpaid' && r.unitsUnpaid===0) return;
            const paidPct = r.totalUnits? Math.round(r.unitsPaid/r.totalUnits*100):0;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${r.code}</td><td>${Math.round(r.totalUnits)}</td><td>${Math.round(r.unitsPaid)}</td><td>${Math.round(r.unitsUnpaid)}</td><td>${paidPct}%</td><td>${r.encounters}</td><td>${r.paidEnc}</td><td>${r.unpaidEnc}</td><td>${r.paidEncPct}%</td><td>${fmtMoney(r.totalPaid)}</td>`;
            tbodyN.appendChild(tr);
            T_total+=r.totalUnits; T_paid+=r.unitsPaid; T_amt+=r.totalPaid;
          });
          const T_unpaid = T_total - T_paid; const T_pct = T_total? Math.round(T_paid/T_total*100):0;
          const ebAll = encBreakdown(filtered);
          tfootN.innerHTML = `<tr><td><strong>Total</strong></td><td><strong>${Math.round(T_total)}</strong></td><td><strong>${Math.round(T_paid)}</strong></td><td><strong>${Math.round(T_unpaid)}</strong></td><td><strong>${T_pct}%</strong></td><td><strong>${ebAll.enc}</strong></td><td><strong>${ebAll.paid}</strong></td><td><strong>${ebAll.unpaid}</strong></td><td><strong>${ebAll.pct}%</strong></td><td><strong>${fmtMoney(T_amt)}</strong></td></tr>`;
        }
        rebuildAndRenderSummaryNUM();
        codeSelectN.addEventListener('change', rebuildAndRenderSummaryNUM);
        paidSelectN.addEventListener('change', rebuildAndRenderSummaryNUM);
        tableN.appendChild(tbodyN); tableN.appendChild(tfootN); summaryNum.appendChild(tableN); output.appendChild(summaryNum);

        // Per-Provider Numeric Breakdown
        function renderProviderBreakdownsNUM(){
          const selectedProvsN = Array.from(selectedProviders.size? selectedProviders : providers);
          selectedProvsN.forEach(p => {
            const pCard = document.createElement('div'); pCard.className='card'; pCard.innerHTML = `<h3>Provider Breakdown â€” ${p} (0â€“9)</h3>`;
            const rowsP = claimsNUM.filter(c=>c.provider===p);
            const byCodeP = new Map(); rowsP.forEach(r=>{ if(!byCodeP.has(r.cpt)) byCodeP.set(r.cpt, []); byCodeP.get(r.cpt).push(r); });
            const codesP = Array.from(byCodeP.keys()).sort((a,b)=>a.localeCompare(b));
            const tblP = document.createElement('table');
            tblP.innerHTML = `<thead><tr>
              <th style='width:12%'>CPT Code</th>
              <th style='width:10%'>Total Units</th>
              <th style='width:10%'>Units Paid</th>
              <th style='width:10%'>Units Unpaid</th>
              <th style='width:8%'>Paid %</th>
              <th style='width:10%'>Encounters</th>
              <th style='width:10%'>Paid Enc</th>
              <th style='width:10%'>Unpaid Enc</th>
              <th style='width:10%'>Paid Enc %</th>
              <th style='width:10%'>Total Paid ($)</th>
            </tr></thead>`;
            const tbP = document.createElement('tbody');
            let TT=0, TP=0, TAmt=0; let TEnc=0, TEncPaid=0;
            codesP.forEach(code=>{
              const vals = byCodeP.get(code);
              const totalUnits = vals.reduce((s,x)=>s+x.units,0);
              const unitsPaid = vals.filter(x=>x.isPaid).reduce((s,x)=>s+x.units,0);
              const unitsUnpaid = totalUnits - unitsPaid;
              const paidPct = totalUnits? Math.round(unitsPaid/totalUnits*100) : 0;
              const eb = encBreakdown(vals);
              const totalPaid = vals.reduce((s,x)=>s+x.paid,0);
              const rowEl = document.createElement('tr'); rowEl.innerHTML = `<td>${code}</td><td>${Math.round(totalUnits)}</td><td>${Math.round(unitsPaid)}</td><td>${Math.round(unitsUnpaid)}</td><td>${paidPct}%</td><td>${eb.enc}</td><td>${eb.paid}</td><td>${eb.unpaid}</td><td>${eb.pct}%</td><td>${fmtMoney(totalPaid)}</td>`;
              tbP.appendChild(rowEl);
              TT+=totalUnits; TP+=unitsPaid; TAmt+=totalPaid; TEnc+=eb.enc; TEncPaid+=eb.paid;
            });
            const TUnpaid = TT-TP; const TPct = TT? Math.round(TP/TT*100):0; const TEncUnpaid = TEnc - TEncPaid; const TEncPct = TEnc? Math.round(TEncPaid/TEnc*100):0;
            const tfoot = document.createElement('tfoot'); tfoot.innerHTML = `<tr><td><strong>Total</strong></td><td><strong>${Math.round(TT)}</strong></td><td><strong>${Math.round(TP)}</strong></td><td><strong>${Math.round(TUnpaid)}</strong></td><td><strong>${TPct}%</strong></td><td><strong>${TEnc}</strong></td><td><strong>${TEncPaid}</strong></td><td><strong>${TEncUnpaid}</strong></td><td><strong>${TEncPct}%</strong></td><td><strong>${fmtMoney(TAmt)}</strong></td></tr>`;
            tblP.appendChild(tbP); tblP.appendChild(tfoot); pCard.appendChild(tblP); output.appendChild(pCard);
          });
        }
        renderProviderBreakdownsNUM();

        // ===== All Individual Claims (0â€“9): Unpaid / Paid separate =====
        function createClaimsSection(title, claims, isPaidWanted){
          const card = document.createElement('div'); card.className='card';
          card.innerHTML = `<div class="section-title"><h3>${title}</h3>
            <div class="pill-legend"><span class="pill ${isPaidWanted?'pill-paid':'pill-unpaid'}">${isPaidWanted?'PAID':'UNPAID'}</span></div>
            <div class="controls">
              <label>Provider: <select class="prov"><option value="">All</option></select></label>
              <label>CPT: <select class="cpt"><option value="">All</option></select></label>
              <label>DOS from: <input type="date" class="from"></label>
              <label>to: <input type="date" class="to"></label>
            </div>
          </div>`;
          const tbl = document.createElement('table');
          tbl.innerHTML = '<thead><tr><th style="width:6%">#</th><th style="width:16%">Provider</th><th style="width:20%">Payer</th><th style="width:10%">Patient ID</th><th style="width:10%">CPT</th><th style="width:8%">Units</th><th style="width:12%">DOS</th><th style="width:12%">Charge ($)</th><th style="width:12%">Paid ($)</th></tr></thead>';
          const tb = document.createElement('tbody');
          const provSel = card.querySelector('.prov');
          const cptSel = card.querySelector('.cpt');
          const fromEl = card.querySelector('.from');
          const toEl = card.querySelector('.to');
          provSel.innerHTML = '<option value="">All</option>' + providers.map(p=>`<option value="${p}">${p}</option>`).join('');
          const codeSet = Array.from(new Set(claims.map(c=>c.cpt))).sort((a,b)=>a.localeCompare(b));
          cptSel.innerHTML = '<option value="">All</option>' + codeSet.map(c=>`<option value="${c}">${c}</option>`).join('');
          function render(){
            tb.innerHTML='';
            const selProv = provSel.value; const selCode = cptSel.value;
            const fromVal = fromEl.value ? new Date(fromEl.value).getTime() : -Infinity;
            const toVal = toEl.value ? new Date(toEl.value).getTime() : Infinity;
            const base = claims.filter(c=> (selectedProviders.size? selectedProviders.has(c.provider): true) && c.isPaid===isPaidWanted);
            base.forEach(r=>{
              if (selProv && r.provider !== selProv) return;
              if (selCode && r.cpt !== selCode) return;
              const t = r.dateSort; if (!(t>=fromVal && t<=toVal)) return;
              tb.innerHTML += `<tr><td>${r.claimNo}</td><td>${r.provider}</td><td>${r.payer||''}</td><td>${r.patient_id}</td><td>${r.cpt}</td><td>${Math.round(r.units)}</td><td>${r.dos||''}</td><td>${fmtMoney(r.charge)}</td><td>${fmtMoney(r.paid)}</td></tr>`;
            });
          }
          render();
          provSel.addEventListener('change', render);
          cptSel.addEventListener('change', render);
          fromEl.addEventListener('change', render);
          toEl.addEventListener('change', render);
          tbl.appendChild(tb); card.appendChild(tbl); output.appendChild(card);
          return { render }
        }

        const numUnpaid = createClaimsSection('All Individual Claims (0â€“9) â€” Unpaid', claimsNUM, false);
        const numPaid = createClaimsSection('All Individual Claims (0â€“9) â€” Paid', claimsNUM, true);
        function renderClaimsNUMUnpaid(){ numUnpaid.render(); }
        function renderClaimsNUMPaid(){ numPaid.render(); }
        // initial
        renderClaimsNUMUnpaid(); renderClaimsNUMPaid();
      }

      // ===== All Individual Claims (A/Q/L): Unpaid / Paid separate =====
      if (claimsAQL.length){
        function createClaimsSectionAQL(title, claims, isPaidWanted){
          const card = document.createElement('div'); card.className='card';
          card.innerHTML = `<div class="section-title"><h3>${title}</h3>
            <div class="pill-legend"><span class="pill ${isPaidWanted?'pill-paid':'pill-unpaid'}">${isPaidWanted?'PAID':'UNPAID'}</span></div>
            <div class="controls">
              <label>Provider: <select class="prov"><option value="">All</option></select></label>
              <label>CPT: <select class="cpt"><option value="">All</option></select></label>
              <label>DOS from: <input type="date" class="from"></label>
              <label>to: <input type="date" class="to"></label>
            </div>
          </div>`;
          const tbl = document.createElement('table');
          tbl.innerHTML = '<thead><tr><th style="width:6%">#</th><th style="width:16%">Provider</th><th style="width:20%">Payer</th><th style="width:10%">Patient ID</th><th style="width:10%">CPT</th><th style="width:8%">Units</th><th style="width:12%">DOS</th><th style="width:12%">Charge ($)</th><th style="width:12%">Paid ($)</th></tr></thead>';
          const tb = document.createElement('tbody');
          const provSel = card.querySelector('.prov');
          const cptSel = card.querySelector('.cpt');
          const fromEl = card.querySelector('.from');
          const toEl = card.querySelector('.to');
          provSel.innerHTML = '<option value="">All</option>' + providers.map(p=>`<option value="${p}">${p}</option>`).join('');
          const codeSet = Array.from(new Set(claims.map(c=>c.cpt))).sort((a,b)=>a.localeCompare(b));
          cptSel.innerHTML = '<option value="">All</option>' + codeSet.map(c=>`<option value="${c}">${c}</option>`).join('');
          function render(){
            tb.innerHTML='';
            const selProv = provSel.value; const selCode = cptSel.value;
            const fromVal = fromEl.value ? new Date(fromEl.value).getTime() : -Infinity;
            const toVal = toEl.value ? new Date(toEl.value).getTime() : Infinity;
            const base = claims.filter(c=> (selectedProviders.size? selectedProviders.has(c.provider): true) && c.isPaid===isPaidWanted);
            base.forEach(r=>{
              if (selProv && r.provider !== selProv) return;
              if (selCode && r.cpt !== selCode) return;
              const t = r.dateSort; if (!(t>=fromVal && t<=toVal)) return;
              tb.innerHTML += `<tr><td>${r.claimNo}</td><td>${r.provider}</td><td>${r.payer||''}</td><td>${r.patient_id}</td><td>${r.cpt}</td><td>${Math.round(r.units)}</td><td>${r.dos||''}</td><td>${fmtMoney(r.charge)}</td><td>${fmtMoney(r.paid)}</td></tr>`;
            });
          }
          render();
          provSel.addEventListener('change', render);
          cptSel.addEventListener('change', render);
          fromEl.addEventListener('change', render);
          toEl.addEventListener('change', render);
          tbl.appendChild(tb); card.appendChild(tbl); output.appendChild(card);
          return { render }
        }

        const aqlUnpaid = createClaimsSectionAQL('All Individual Claims (A/Q/L) â€” Unpaid', claimsAQL, false);
        const aqlPaid = createClaimsSectionAQL('All Individual Claims (A/Q/L) â€” Paid', claimsAQL, true);
        function renderClaimsAQLUnpaid(){ aqlUnpaid.render(); }
        function renderClaimsAQLPaid(){ aqlPaid.render(); }
        // initial
        renderClaimsAQLUnpaid(); renderClaimsAQLPaid();
      }
    }
  </script>
</body>
</html>
